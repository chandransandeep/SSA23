<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam Preparation Quiz</title>
  <!-- ... (keep your CSS and fonts as is) ... -->
  <style>
    /* ... --- your existing CSS here, unchanged --- ... */
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    window.firebaseApp = null;
    window.db = null;
    window.auth = null;
    window.currentUserId = null;
    window.isFirebaseReady = false;

    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.collection = collection;
    window.deleteDoc = deleteDoc;

    window.loadSettingsAndQuiz = async function() {
      if (!window.isFirebaseReady || !window.db || !window.currentUserId) {
        const errorEl = document.getElementById('error-message');
        if (errorEl) errorEl.textContent = 'Waiting for authentication...';
        return;
      }
      const errorEl = document.getElementById('error-message');
      if (errorEl) errorEl.textContent = '';
      try {
        await Promise.all([
          window.loadWronglyAnsweredQuestions(),
          window.loadSettings(),
          window.loadQuizStats()
        ]);
        window.loadQuiz();
      } catch (error) {
        console.error("‚ùå Error loading quiz data:", error);
        if (errorEl) errorEl.textContent = `Error loading quiz: ${error.message}`;
      }
    };

    document.addEventListener('DOMContentLoaded', async () => {
      const firebaseConfig = {
        apiKey: "AIzaSyCmlSLhRNeOrEG4aT9t-JK20QAjzpdELVc",
        authDomain: "studybuddy-58e84.firebaseapp.com",
        projectId: "studybuddy-58e84",
        storageBucket: "studybuddy-58e84.firebasestorage.app",
        messagingSenderId: "143466700741",
        appId: "1:143466700741:web:9db108d70302aed8c435ac",
        measurementId: "G-0K69MEBD6Q"
      };
      window.firebaseConfig = firebaseConfig;
      try {
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);

        let authAttempts = 0;
        const maxAuthAttempts = 3;
        const attemptAuth = async () => {
          try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
              await signInWithCustomToken(window.auth, __initial_auth_token);
              console.log("‚úÖ Signed in with custom token");
            } else {
              await signInAnonymously(window.auth);
              console.log("‚úÖ Signed in anonymously");
            }
          } catch (error) {
            authAttempts++;
            if (authAttempts < maxAuthAttempts) {
              const errorEl = document.getElementById('error-message');
              if (errorEl) errorEl.textContent = `Authentication failed (attempt ${authAttempts}/${maxAuthAttempts}). Retrying...`;
              setTimeout(attemptAuth, 2000);
            } else {
              const errorEl = document.getElementById('error-message');
              if (errorEl) errorEl.textContent = `Authentication failed after ${maxAuthAttempts} attempts. Please refresh the page.`;
            }
          }
        };
        await attemptAuth();

        onAuthStateChanged(window.auth, (user) => {
          if (user) {
            window.currentUserId = user.uid;
            const userDisplayEl = document.getElementById('user-id-display');
            if (userDisplayEl) {
              userDisplayEl.innerHTML = `<strong>User ID:</strong> ${window.currentUserId.substring(0, 8)}...`;
            }
            window.isFirebaseReady = true;
            window.loadSettingsAndQuiz();
          } else {
            window.currentUserId = null;
            const userDisplayEl = document.getElementById('user-id-display');
            if (userDisplayEl) userDisplayEl.textContent = '‚ùå Not authenticated';
            window.isFirebaseReady = false;
          }
        });
      } catch (error) {
        const errorEl = document.getElementById('error-message');
        if (errorEl) errorEl.textContent = `Firebase initialization failed: ${error.message}`;
      }
    });
  </script>
</head>
<body>
  <div class="app-container">
    <h1 id="quiz-title-display">üìö Exam Preparation Quiz</h1>
    <div class="quiz-container">
      <div class="settings-panel">
        <div class="settings-grid">
          <div class="setting-group">
            <label for="quiz-title-input">üìù Quiz Title:</label>
            <input type="text" id="quiz-title-input" placeholder="My Biology Exam Prep" value="General Exam Preparation Quiz">
          </div>
          <div class="setting-group">
            <label for="num-questions">üî¢ Number of Questions:</label>
            <input type="number" id="num-questions" min="1" placeholder="All questions" value="10">
          </div>
          <div class="setting-group">
            <div class="checkbox-group">
              <input type="checkbox" id="enable-timer-checkbox">
              <label for="enable-timer-checkbox">‚è∞ Enable Timer</label>
            </div>
            <label for="time-limit-minutes">‚è±Ô∏è Time Limit (minutes):</label>
            <input type="number" id="time-limit-minutes" min="1" value="10">
          </div>
        </div>
        <button type="button" id="clear-wrong-answers-btn">üóëÔ∏è Clear Wrong Answers History</button>
        <button type="button" id="toggle-quiz-mode-btn">Show All Questions</button>
      </div>
      <div class="stats-panel" id="stats-panel" style="display: none;">
        <div class="stat-item">
          <div class="stat-value" id="total-questions-stat">0</div>
          <div class="stat-label">Total Questions</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="wrong-answers-stat">0</div>
          <div class="stat-label">Wrong Answers</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="completion-rate-stat">0%</div>
          <div class="stat-label">Completion Rate</div>
        </div>
      </div>
      <div class="progress-bar" id="progress-bar" style="display: none;">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div id="timer-display"></div>
      <div id="user-id-display">üîê Authenticating...</div>
      <form id="quiz-form">
        <div id="questions-container">
          <div class="loading-spinner"></div>
          Loading questions...
        </div>
        <button type="submit" class="submit-btn">üì§ Submit Answers</button>
        <button type="button" id="retake-quiz-btn" class="retake-btn">üîÑ Retake Quiz</button>
      </form>
      <div id="score-container" class="score-container"></div>
      <div id="error-message" class="error-message"></div>
    </div>
  </div>
  <script type="text/javascript">
    // Quiz state
    let allQuizQuestions = [];
    let currentQuizQuestions = [];
    let wronglyAnsweredQuestions = new Set();
    let lastQuizResults = {}; // {questionText: "correct"|"wrong"|"unanswered"}
    let quizMode = "wrong"; // "wrong" or "all"
    let quizForm = null;

    // CSV, shuffle, and create question helpers (as before)
    // ... (your parseCSV, shuffleArray, and createQuestionElement functions remain unchanged) ...

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      if (lines.length === 0) return [];
      const headers = lines[0].split(',').map(header => header.trim().replace(/^"|"$/g, ''));
      const requiredHeaders = ["QuestionText", "OptionA", "OptionB", "OptionC", "OptionD", "Answer", "Explanation"];
      const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
      if (missingHeaders.length > 0) {
        throw new Error(`‚ùå Missing required CSV headers: ${missingHeaders.join(', ')}`);
      }
      return lines.slice(1).map((line, index) => {
        try {
          const values = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
            .map(v => v.replace(/^"|"$/g, '').trim());
          if (values.length !== headers.length) {
            console.warn(`‚ö†Ô∏è Skipping malformed row ${index + 2}: Expected ${headers.length} columns, got ${values.length}`);
            return null;
          }
          return headers.reduce((obj, header, i) => {
            obj[header] = values[i];
            return obj;
          }, {});
        } catch (error) {
          console.warn(`‚ö†Ô∏è Error parsing row ${index + 2}:`, error);
          return null;
        }
      }).filter(row => row !== null);
    }

    function createQuestionElement(question, index) {
      const options = {
        A: question.OptionA || '',
        B: question.OptionB || '',
        C: question.OptionC || '',
        D: question.OptionD || ''
      };
      return `
        <div class="question" data-question-index="${index}" role="group" aria-labelledby="question-${index}-title">
          <div class="question-title" id="question-${index}-title">
            ${index + 1}. ${question.QuestionText || 'No Question Text'}
          </div>
          <div class="options" role="radiogroup" aria-labelledby="question-${index}-title">
            ${Object.entries(options).map(([key, value]) => `
              <label for="q${index}-${key}">
                <input type="radio" name="q${index}" value="${key}" id="q${index}-${key}" aria-describedby="question-${index}-title" />
                <span>${key}. ${value}</span>
              </label>
            `).join('')}
          </div>
          <div class="result" id="result-q${index}" role="status" aria-live="polite"></div>
          <div class="explanation" id="explanation-q${index}" role="note"></div>
          <div class="question-actions">
            <button type="button" class="validate-btn" data-question-index="${index}" aria-label="Validate answer for question ${index + 1}">
              ‚úÖ Validate Answer
            </button>
          </div>
        </div>
      `;
    }

    // Main quiz loading logic with mode support
    async function loadQuiz() {
      const questionsContainer = document.getElementById('questions-container');
      try {
        // Load questions from CSV or use sample data
        allQuizQuestions = await loadCSVData();
        if (allQuizQuestions.length === 0) {
          questionsContainer.innerHTML = '<p>‚ùå No questions available. Please upload a CSV file with questions.</p>';
          return;
        }
        // Mode selection
        let questionsToShow = [];
        if (quizMode === "wrong") {
          questionsToShow = allQuizQuestions.filter(q => lastQuizResults[q.QuestionText] !== "correct");
        } else {
          questionsToShow = allQuizQuestions.slice();
        }
        // If none left in wrong mode, show congrats and offer to retake all
        if (quizMode === "wrong" && questionsToShow.length === 0) {
          questionsContainer.innerHTML = '<p>üéâ All questions have been answered correctly! <br><button id="show-all-btn" type="button">Restart Full Quiz</button></p>';
          document.getElementById('show-all-btn').onclick = () => {
            quizMode = "all";
            document.getElementById('toggle-quiz-mode-btn').textContent = "Retake Only Wrong/Unanswered";
            loadQuiz();
          };
          document.querySelector('.submit-btn').style.display = 'none';
          document.getElementById('retake-quiz-btn').style.display = 'none';
          document.getElementById('score-container').innerHTML = '';
          return;
        }
        // Limit number of questions if needed
        const numQuestionsInput = document.getElementById('num-questions');
        const numQuestions = parseInt(numQuestionsInput.value) || questionsToShow.length;
        currentQuizQuestions = shuffleArray(questionsToShow).slice(0, numQuestions);
        // Generate quiz HTML
        questionsContainer.innerHTML = currentQuizQuestions
          .map((question, index) => createQuestionElement(question, index))
          .join('');
        setupEventListeners();
        updateQuizStats();
        document.querySelector('.submit-btn').style.display = 'block';
        document.getElementById('retake-quiz-btn').style.display = 'none';
      } catch (error) {
        questionsContainer.innerHTML = `<p>‚ùå Error loading quiz: ${error.message}</p>`;
      }
    }

    function setupEventListeners() {
      quizForm = document.getElementById('quiz-form');
      document.querySelectorAll('.validate-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.questionIndex);
          validateSingleQuestion(index);
        });
      });
      quizForm.addEventListener('submit', (e) => {
        e.preventDefault();
        submitQuiz();
      });
      document.getElementById('retake-quiz-btn').onclick = () => {
        loadQuiz();
        document.getElementById('score-container').innerHTML = '';
      };
      document.getElementById('clear-wrong-answers-btn').onclick = async () => {
        wronglyAnsweredQuestions.clear();
        lastQuizResults = {};
        await saveWronglyAnsweredQuestions();
        updateQuizStats();
        loadQuiz();
      };
      quizForm.addEventListener('change', updateProgress);
      document.getElementById('toggle-quiz-mode-btn').onclick = () => {
        quizMode = (quizMode === "all") ? "wrong" : "all";
        document.getElementById('toggle-quiz-mode-btn').textContent =
          quizMode === "all" ? "Retake Only Wrong/Unanswered" : "Show All Questions";
        loadQuiz();
      };
    }

    function validateSingleQuestion(index) {
      const question = currentQuizQuestions[index];
      const selectedOption = quizForm.querySelector(`input[name="q${index}"]:checked`);
      const resultElement = document.getElementById(`result-q${index}`);
      const explanationElement = document.getElementById(`explanation-q${index}`);
      const questionDiv = document.querySelector(`.question[data-question-index="${index}"]`);
      resultElement.textContent = '';
      resultElement.className = 'result';
      explanationElement.textContent = '';
      explanationElement.style.display = 'none';
      questionDiv.querySelectorAll('label').forEach(label => {
        label.style.backgroundColor = '';
        label.style.border = '2px solid #e1e8ed';
        label.style.transform = '';
      });
      if (!selectedOption) {
        resultElement.textContent = '‚ö†Ô∏è Please select an answer for this question.';
        resultElement.classList.add('wrong');
        lastQuizResults[question.QuestionText] = "unanswered";
        return false;
      }
      const selectedValue = selectedOption.value;
      const correctAnswer = question.Answer;
      if (selectedValue === correctAnswer) {
        resultElement.textContent = 'üéâ Correct! Well done!';
        resultElement.classList.add('correct');
        selectedOption.parentElement.style.background = 'linear-gradient(135deg, #d5f4e6 0%, #a8e6a8 100%)';
        selectedOption.parentElement.style.border = '2px solid #27ae60';
        selectedOption.parentElement.style.transform = 'scale(1.02)';
        wronglyAnsweredQuestions.delete(question.QuestionText);
        lastQuizResults[question.QuestionText] = "correct";
        saveWronglyAnsweredQuestions();
        updateProgress();
        return true;
      } else {
        resultElement.textContent = `‚ùå Incorrect. The correct answer is ${correctAnswer}.`;
        resultElement.classList.add('wrong');
        selectedOption.parentElement.style.background = 'linear-gradient(135deg, #fdf2f2 0%, #fed7d7 100%)';
        selectedOption.parentElement.style.border = '2px solid #e74c3c';
        wronglyAnsweredQuestions.add(question.QuestionText);
        lastQuizResults[question.QuestionText] = "wrong";
        saveWronglyAnsweredQuestions();
        if (question.Explanation) {
          explanationElement.textContent = `üí° Explanation: ${question.Explanation}`;
          explanationElement.style.display = 'block';
        }
        const correctLabel = quizForm.querySelector(`input[name="q${index}"][value="${correctAnswer}"]`);
        if (correctLabel) {
          correctLabel.parentElement.style.background = 'linear-gradient(135deg, #d5f4e6 0%, #a8e6a8 100%)';
          correctLabel.parentElement.style.border = '2px solid #27ae60';
        }
        updateProgress();
        return false;
      }
    }

    function updateProgress() {
      const totalQuestions = currentQuizQuestions.length;
      const answeredQuestions = quizForm.querySelectorAll('input[type="radio"]:checked').length;
      const progressPercentage = totalQuestions > 0 ? (answeredQuestions / totalQuestions) * 100 : 0;
      const progressBar = document.getElementById('progress-bar');
      const progressFill = document.getElementById('progress-fill');
      if (answeredQuestions > 0) {
        progressBar.style.display = 'block';
        progressFill.style.width = `${progressPercentage}%`;
      }
      updateQuizStats();
    }

    function updateQuizStats() {
      loadQuizStats();
    }
    async function loadQuizStats() {
      const statsPanel = document.getElementById('stats-panel');
      const totalQuestionsEl = document.getElementById('total-questions-stat');
      const wrongAnswersEl = document.getElementById('wrong-answers-stat');
      const completionRateEl = document.getElementById('completion-rate-stat');
      try {
        const totalQuestions = allQuizQuestions.length;
        const wrongAnswersCount = wronglyAnsweredQuestions.size;
        const completionRate = totalQuestions > 0 ? Math.round(((totalQuestions - wrongAnswersCount) / totalQuestions) * 100) : 0;
        totalQuestionsEl.textContent = totalQuestions;
        wrongAnswersEl.textContent = wrongAnswersCount;
        completionRateEl.textContent = `${completionRate}%`;
        if (totalQuestions > 0) {
          statsPanel.style.display = 'grid';
        }
      } catch (error) {
        console.error("‚ùå Error loading quiz stats:", error);
      }
    }

    async function loadCSVData() {
      try {
        const response = await fetch('./questions.csv');
        if (!response.ok) {
          return getSampleQuestions();
        }
        const csvText = await response.text();
        return parseCSV(csvText);
      } catch (error) {
        return getSampleQuestions();
      }
    }
    function getSampleQuestions() {
      return [
        {
          QuestionText: "What is the capital of France?",
          OptionA: "London",
          OptionB: "Berlin",
          OptionC: "Paris",
          OptionD: "Madrid",
          Answer: "C",
          Explanation: "Paris is the capital and most populous city of France."
        },
        {
          QuestionText: "Which planet is known as the Red Planet?",
          OptionA: "Venus",
          OptionB: "Mars",
          OptionC: "Jupiter",
          OptionD: "Saturn",
          Answer: "B",
          Explanation: "Mars is called the Red Planet due to iron oxide (rust) on its surface."
        }
      ];
    }

    function submitQuiz() {
      let correctCount = 0;
      const totalQuestions = currentQuizQuestions.length;

      currentQuizQuestions.forEach((question, index) => {
        const selectedOption = quizForm.querySelector(`input[name="q${index}"]:checked`);
        if (selectedOption && selectedOption.value === question.Answer) {
          correctCount++;
          lastQuizResults[question.QuestionText] = "correct";
        } else if (selectedOption) {
          lastQuizResults[question.QuestionText] = "wrong";
        } else {
          lastQuizResults[question.QuestionText] = "unanswered";
        }
      });
      saveWronglyAnsweredQuestions();
      const percentage = Math.round((correctCount / totalQuestions) * 100);
      document.getElementById('score-container').innerHTML = `
        <h2>üéØ Quiz Results</h2>
        <p>You scored <strong>${correctCount}/${totalQuestions}</strong> (${percentage}%)</p>
        <p>${getPerformanceMessage(percentage)}</p>
      `;
      document.querySelector('.submit-btn').style.display = 'none';
      document.getElementById('retake-quiz-btn').style.display = 'block';
      document.getElementById('score-container').scrollIntoView({ behavior: 'smooth' });
    }
    function getPerformanceMessage(percentage) {
      if (percentage >= 90) return "üåü Excellent work! You're mastering this topic!";
      if (percentage >= 80) return "üëç Great job! You have a solid understanding!";
      if (percentage >= 70) return "üëå Good work! A little more practice will help!";
      if (percentage >= 60) return "üìö Keep studying! You're making progress!";
      return "üí™ Don't give up! Review the material and try again!";
    }

    // --- Firebase save/load for wrong answers and lastQuizResults ---

    async function loadWronglyAnsweredQuestions() {
      if (window.currentUserId && window.db) {
        try {
          const userDocRef = window.doc(window.db, "users", window.currentUserId);
          const docSnap = await window.getDoc(userDocRef);
          if (docSnap.exists()) {
            const data = docSnap.data();
            wronglyAnsweredQuestions = new Set(data.wronglyAnsweredQuestions ?? []);
            lastQuizResults = data.lastQuizResults ?? {};
          } else {
            wronglyAnsweredQuestions = new Set();
            lastQuizResults = {};
          }
        } catch (e) {
          wronglyAnsweredQuestions = new Set(JSON.parse(localStorage.getItem('wronglyAnsweredQuestions') || "[]"));
          lastQuizResults = JSON.parse(localStorage.getItem('lastQuizResults') || "{}");
        }
      } else {
        wronglyAnsweredQuestions = new Set(JSON.parse(localStorage.getItem('wronglyAnsweredQuestions') || "[]"));
        lastQuizResults = JSON.parse(localStorage.getItem('lastQuizResults') || "{}");
      }
    }

    async function saveWronglyAnsweredQuestions() {
      localStorage.setItem('wronglyAnsweredQuestions', JSON.stringify([...wronglyAnsweredQuestions]));
      localStorage.setItem('lastQuizResults', JSON.stringify(lastQuizResults));
      if (window.currentUserId && window.db) {
        try {
          const userDocRef = window.doc(window.db, "users", window.currentUserId);
          await window.setDoc(userDocRef, {
            wronglyAnsweredQuestions: [...wronglyAnsweredQuestions],
            lastQuizResults: lastQuizResults
          }, { merge: true });
        } catch (e) {
          // fallback already done above
        }
      }
    }

    async function loadSettings() {
      // Add settings load/save from Firebase if needed
    }

    // Expose functions globally for module script
    window.loadWronglyAnsweredQuestions = loadWronglyAnsweredQuestions;
    window.loadSettings = loadSettings;
    window.loadQuizStats = loadQuizStats;
    window.loadQuiz = loadQuiz;
    window.saveWronglyAnsweredQuestions = saveWronglyAnsweredQuestions;
    window.updateQuizStats = updateQuizStats;
    window.updateProgress = updateProgress;
    window.validateSingleQuestion = validateSingleQuestion;
    window.createQuestionElement = createQuestionElement;
    window.parseCSV = parseCSV;
    window.shuffleArray = shuffleArray;

    // For debugging
    window.lastQuizResults = lastQuizResults;
    window.allQuizQuestions = allQuizQuestions;
    window.currentQuizQuestions = currentQuizQuestions;
    window.wronglyAnsweredQuestions = wronglyAnsweredQuestions;

    console.log("‚úÖ All functions loaded and ready");
  </script>
</body>
</html>
