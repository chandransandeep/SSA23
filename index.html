<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam Preparation Quiz</title>
  <style>
    /* Enhanced CSS with modern design improvements */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #333;
      line-height: 1.6;
    }
    
    .app-container {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }
    
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .quiz-container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .settings-panel {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      border: none;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
    }
    
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .setting-group {
      display: flex;
      flex-direction: column;
    }
    
    .settings-panel label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
      font-size: 0.9em;
    }
    
    .settings-panel input[type="number"],
    .settings-panel input[type="text"] {
      padding: 10px 15px;
      border: 2px solid #e1e8ed;
      border-radius: 10px;
      font-size: 1em;
      transition: all 0.3s ease;
      background: white;
    }
    
    .settings-panel input[type="number"]:focus,
    .settings-panel input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #667eea;
    }
    
    .settings-panel button {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(238, 90, 36, 0.3);
    }
    
    .settings-panel button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(238, 90, 36, 0.4);
    }
    
    #timer-display {
      text-align: center;
      font-size: 1.8em;
      font-weight: bold;
      color: #e74c3c;
      margin-bottom: 25px;
      padding: 15px;
      background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
      border: 2px solid #fc8181;
      border-radius: 15px;
      display: none;
    }
    
    #user-id-display {
      text-align: center;
      font-size: 0.85em;
      margin-bottom: 20px;
      padding: 10px;
      background: linear-gradient(135deg, #f0f4f7 0%, #d6eaf8 100%);
      border-radius: 10px;
      color: #555;
      word-break: break-all;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e1e8ed;
      border-radius: 4px;
      margin-bottom: 30px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .question {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      margin-bottom: 25px;
      padding: 25px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      transition: transform 0.2s ease;
    }
    
    .question:hover {
      transform: translateY(-2px);
    }
    
    .question-title {
      font-weight: 700;
      margin-bottom: 20px;
      font-size: 1.2em;
      color: #2c3e50;
      line-height: 1.4;
    }
    
    .options {
      display: grid;
      gap: 12px;
    }
    
    .options label {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      cursor: pointer;
      border: 2px solid #e1e8ed;
      border-radius: 12px;
      transition: all 0.3s ease;
      background: white;
      font-weight: 500;
    }
    
    .options label:hover {
      border-color: #667eea;
      background: linear-gradient(135deg, #f0f4ff 0%, #e6eeff 100%);
      transform: translateX(5px);
    }
    
    .options input[type="radio"] {
      width: 20px;
      height: 20px;
      margin-right: 15px;
      accent-color: #667eea;
    }
    
    .question-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    .validate-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }
    
    .validate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }
    
    .submit-btn, .retake-btn {
      width: 100%;
      padding: 18px 25px;
      font-size: 1.3em;
      font-weight: 700;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      margin-top: 30px;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .submit-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    .submit-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
    }
    
    .retake-btn {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      box-shadow: 0 8px 25px rgba(46, 204, 113, 0.3);
      display: none;
    }
    
    .retake-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(46, 204, 113, 0.4);
    }
    
    .result {
      margin-top: 15px;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 10px;
      text-align: center;
      font-size: 1em;
    }
    
    .correct {
      color: #27ae60;
      background: linear-gradient(135deg, #d5f4e6 0%, #a8e6a8 100%);
      border: 2px solid #27ae60;
    }
    
    .wrong {
      color: #e74c3c;
      background: linear-gradient(135deg, #fdf2f2 0%, #fed7d7 100%);
      border: 2px solid #e74c3c;
    }
    
    .explanation {
      margin-top: 15px;
      padding: 15px 20px;
      background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
      border: 2px solid #3498db;
      border-radius: 10px;
      font-size: 0.95em;
      color: #2c3e50;
      line-height: 1.6;
      display: none;
    }
    
    .score-container {
      margin-top: 40px;
      padding: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      text-align: center;
      font-size: 1.5em;
      font-weight: 700;
      color: white;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    .error-message {
      color: #e74c3c;
      font-weight: 600;
      text-align: center;
      margin-top: 20px;
      padding: 15px 20px;
      background: linear-gradient(135deg, #fdf2f2 0%, #fed7d7 100%);
      border: 2px solid #e74c3c;
      border-radius: 10px;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .stats-panel {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .stat-item {
      text-align: center;
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .stat-value {
      font-size: 1.5em;
      font-weight: 700;
      color: #667eea;
    }
    
    .stat-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      h1 {
        font-size: 2em;
      }
      
      .quiz-container {
        padding: 20px;
        border-radius: 15px;
      }
      
      .settings-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .question {
        padding: 20px;
      }
      
      .options label {
        padding: 12px 15px;
      }
      
      .submit-btn, .retake-btn {
        font-size: 1.1em;
        padding: 15px 20px;
      }
    }
    
    @media (max-width: 480px) {
      .options label:hover {
        transform: none;
      }
      
      .question:hover {
        transform: none;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Global Firebase variables
    window.firebaseApp = null;
    window.db = null;
    window.auth = null;
    window.currentUserId = null;
    window.isFirebaseReady = false;

    // Expose Firestore functions globally
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.collection = collection;
    window.deleteDoc = deleteDoc;

    document.addEventListener('DOMContentLoaded', async () => {
        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCmlSLhRNeOrEG4aT9t-JK20QAjzpdELVc",
          authDomain: "studybuddy-58e84.firebaseapp.com",
          projectId: "studybuddy-58e84",
          storageBucket: "studybuddy-58e84.firebasestorage.app",
          messagingSenderId: "143466700741",
          appId: "1:143466700741:web:9db108d70302aed8c435ac",
          measurementId: "G-0K69MEBD6Q"
        };
        window.firebaseConfig = firebaseConfig;

        try {
            // Initialize Firebase
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // Enhanced authentication with retry logic
            let authAttempts = 0;
            const maxAuthAttempts = 3;
            
            const attemptAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(window.auth, __initial_auth_token);
                        console.log("✅ Signed in with custom token");
                    } else {
                        await signInAnonymously(window.auth);
                        console.log("✅ Signed in anonymously");
                    }
                } catch (error) {
                    authAttempts++;
                    console.error(`❌ Authentication attempt ${authAttempts} failed:`, error);
                    
                    if (authAttempts < maxAuthAttempts) {
                        document.getElementById('error-message').textContent = `Authentication failed (attempt ${authAttempts}/${maxAuthAttempts}). Retrying...`;
                        setTimeout(attemptAuth, 2000);
                    } else {
                        document.getElementById('error-message').textContent = `Authentication failed after ${maxAuthAttempts} attempts. Please refresh the page.`;
                    }
                }
            };

            await attemptAuth();

            // Listen for auth state changes
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    window.currentUserId = user.uid;
                    document.getElementById('user-id-display').innerHTML = `
                        <strong>User ID:</strong> ${window.currentUserId.substring(0, 8)}...
                    `;
                    window.isFirebaseReady = true;
                    console.log("🔥 Firebase ready with user:", window.currentUserId);
                    window.loadSettingsAndQuiz();
                } else {
                    window.currentUserId = null;
                    document.getElementById('user-id-display').textContent = '❌ Not authenticated';
                    window.isFirebaseReady = false;
                }
            });
        } catch (error) {
            console.error("❌ Firebase initialization failed:", error);
            document.getElementById('error-message').textContent = `Firebase initialization failed: ${error.message}`;
        }
    });
  </script>
</head>
<body>
  <div class="app-container">
    <h1 id="quiz-title-display">📚 Exam Preparation Quiz</h1>
    
    <div class="quiz-container">
      <div class="settings-panel">
        <div class="settings-grid">
          <div class="setting-group">
            <label for="quiz-title-input">📝 Quiz Title:</label>
            <input type="text" id="quiz-title-input" placeholder="My Biology Exam Prep" value="General Exam Preparation Quiz">
          </div>
          
          <div class="setting-group">
            <label for="num-questions">🔢 Number of Questions:</label>
            <input type="number" id="num-questions" min="1" placeholder="All questions" value="10">
          </div>
          
          <div class="setting-group">
            <div class="checkbox-group">
              <input type="checkbox" id="enable-timer-checkbox">
              <label for="enable-timer-checkbox">⏰ Enable Timer</label>
            </div>
            <label for="time-limit-minutes">⏱️ Time Limit (minutes):</label>
            <input type="number" id="time-limit-minutes" min="1" value="10">
          </div>
        </div>
        
        <button type="button" id="clear-wrong-answers-btn">🗑️ Clear Wrong Answers History</button>
      </div>

      <div class="stats-panel" id="stats-panel" style="display: none;">
        <div class="stat-item">
          <div class="stat-value" id="total-questions-stat">0</div>
          <div class="stat-label">Total Questions</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="wrong-answers-stat">0</div>
          <div class="stat-label">Wrong Answers</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="completion-rate-stat">0%</div>
          <div class="stat-label">Completion Rate</div>
        </div>
      </div>

      <div class="progress-bar" id="progress-bar" style="display: none;">
        <div class="progress-fill" id="progress-fill"></div>
      </div>

      <div id="timer-display"></div>
      <div id="user-id-display">🔐 Authenticating...</div>

      <form id="quiz-form">
        <div id="questions-container">
          <div class="loading-spinner"></div>
          Loading questions...
        </div>
        <button type="submit" class="submit-btn">📤 Submit Answers</button>
        <button type="button" id="retake-quiz-btn" class="retake-btn">🔄 Retake Quiz</button>
      </form>
      
      <div id="score-container" class="score-container"></div>
      <div id="error-message" class="error-message"></div>
    </div>
  </div>

  <script type="text/javascript">
    // Enhanced JavaScript with improved functionality
    
    window.loadSettingsAndQuiz = async function() {
        if (!window.isFirebaseReady || !window.db || !window.currentUserId) {
            console.warn("⚠️ Firebase not ready yet, deferring quiz load.");
            document.getElementById('error-message').textContent = 'Waiting for authentication...';
            return;
        }
        
        document.getElementById('error-message').textContent = '';
        
        try {
            await Promise.all([
                loadWronglyAnsweredQuestions(),
                loadSettings(),
                loadQuizStats()
            ]);
            loadQuiz();
        } catch (error) {
            console.error("❌ Error loading quiz data:", error);
            document.getElementById('error-message').textContent = `Error loading quiz: ${error.message}`;
        }
    };

    // Enhanced shuffle function with better randomization
    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    // Enhanced CSV parser with better error handling
    function parseCSV(text) {
        const lines = text.trim().split('\n');
        if (lines.length === 0) return [];

        const headers = lines[0].split(',').map(header => header.trim().replace(/^"|"$/g, ''));
        const requiredHeaders = ["QuestionText", "OptionA", "OptionB", "OptionC", "OptionD", "Answer", "Explanation"];
        const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
        
        if (missingHeaders.length > 0) {
            throw new Error(`❌ Missing required CSV headers: ${missingHeaders.join(', ')}`);
        }

        return lines.slice(1).map((line, index) => {
            try {
                const values = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
                    .map(v => v.replace(/^"|"$/g, '').trim());

                if (values.length !== headers.length) {
                    console.warn(`⚠️ Skipping malformed row ${index + 2}: Expected ${headers.length} columns, got ${values.length}`);
                    return null;
                }

                return headers.reduce((obj, header, i) => {
                    obj[header] = values[i];
                    return obj;
                }, {});
            } catch (error) {
                console.warn(`⚠️ Error parsing row ${index + 2}:`, error);
                return null;
            }
        }).filter(row => row !== null);
    }

    // Enhanced question element creation with accessibility improvements
    function createQuestionElement(question, index) {
        const options = {
            A: question.OptionA || '',
            B: question.OptionB || '',
            C: question.OptionC || '',
            D: question.OptionD || ''
        };

        return `
            <div class="question" data-question-index="${index}" role="group" aria-labelledby="question-${index}-title">
                <div class="question-title" id="question-${index}-title">
                    ${index + 1}. ${question.QuestionText || 'No Question Text'}
                </div>
                <div class="options" role="radiogroup" aria-labelledby="question-${index}-title">
                    ${Object.entries(options).map(([key, value]) => `
                        <label for="q${index}-${key}">
                            <input type="radio" name="q${index}" value="${key}" id="q${index}-${key}" aria-describedby="question-${index}-title" />
                            <span>${key}. ${value}</span>
                        </label>
                    `).join('')}
                </div>
                <div class="result" id="result-q${index}" role="status" aria-live="polite"></div>
                <div class="explanation" id="explanation-q${index}" role="note"></div>
                <div class="question-actions">
                    <button type="button" class="validate-btn" data-question-index="${index}" aria-label="Validate answer for question ${index + 1}">
                        ✅ Validate Answer
                    </button>
                </div>
            </div>
        `;
    }

    // Enhanced validation with better feedback
    function validateSingleQuestion(index) {
        const question = currentQuizQuestions[index];
        const selectedOption = quizForm.querySelector(`input[name="q${index}"]:checked`);
        const resultElement = document.getElementById(`result-q${index}`);
        const explanationElement = document.getElementById(`explanation-q${index}`);
        const questionDiv = document.querySelector(`.question[data-question-index="${index}"]`);

        // Reset UI
        resultElement.textContent = '';
        resultElement.className = 'result';
        explanationElement.textContent = '';
        explanationElement.style.display = 'none';
        
        questionDiv.querySelectorAll('label').forEach(label => {
            label.style.backgroundColor = '';
            label.style.border = '2px solid #e1e8ed';
            label.style.transform = '';
        });

        if (!selectedOption) {
            resultElement.textContent = '⚠️ Please select an answer for this question.';
            resultElement.classList.add('wrong');
            return false;
        }

        const selectedValue = selectedOption.value;
        const correctAnswer = question.Answer;

        if (selectedValue === correctAnswer) {
            resultElement.textContent = '🎉 Correct! Well done!';
            resultElement.classList.add('correct');
            selectedOption.parentElement.style.background = 'linear-gradient(135deg, #d5f4e6 0%, #a8e6a8 100%)';
            selectedOption.parentElement.style.border = '2px solid #27ae60';
            selectedOption.parentElement.style.transform = 'scale(1.02)';
            
            wronglyAnsweredQuestions.delete(question.QuestionText);
            saveWronglyAnsweredQuestions();
            updateProgress();
            return true;
        } else {
            resultElement.textContent = `❌ Incorrect. The correct answer is ${correctAnswer}.`;
            resultElement.classList.add('wrong');
            selectedOption.parentElement.style.background = 'linear-gradient(135deg, #fdf2f2 0%, #fed7d7 100%)';
            selectedOption.parentElement.style.border = '2px solid #e74c3c';

            wronglyAnsweredQuestions.add(question.QuestionText);
            saveWronglyAnsweredQuestions();

            if (question.Explanation) {
                explanationElement.textContent = `💡 Explanation: ${question.Explanation}`;
                explanationElement.style.display = 'block';
            }

            // Highlight correct answer
            const correctLabel = quizForm.querySelector(`input[name="q${index}"][value="${correctAnswer}"]`);
            if (correctLabel) {
                correctLabel.parentElement.style.background = 'linear-gradient(135deg, #d5f4e6 0%, #a8e6a8 100%)';
                correctLabel.parentElement.style.border = '2px solid #27ae60';
            }
            
            updateProgress();
            return false;
        }
    }

    // Progress tracking
    function updateProgress() {
        const totalQuestions = currentQuizQuestions.length;
        const answeredQuestions = quizForm.querySelectorAll('input[type="radio"]:checked').length;
        const progressPercentage = totalQuestions > 0 ? (answeredQuestions / totalQuestions) * 100 : 0;
        
        const progressBar = document.getElementById('progress-bar');
        const progressFill = document.getElementById('progress-fill');
        
        if (answeredQuestions > 0) {
            progressBar.style.display = 'block';
            progressFill.style.width = `${progressPercentage}%`;
        }
        
        updateQuizStats();
    }

    // Enhanced quiz statistics
    async function loadQuizStats() {
        const statsPanel = document.getElementById('stats-panel');
        const totalQuestionsEl = document.getElementById('total-questions-stat');
        const wrongAnswersEl = document.getElementById('wrong-answers-stat');
        const completionRateEl = document.getElementById('completion-rate-stat');
        
        try {
            const totalQuestions = allQuizQuestions.length;
            const wrongAnswersCount = wronglyAnsweredQuestions.size;
            const completionRate = totalQuestions > 0 ? Math.round(((totalQuestions - wrongAnswersCount) / totalQuestions) * 100) : 0;
            
            totalQuestionsEl.textContent = totalQuestions;
            wrongAnswersEl.textContent = wrongAnswersCount;
            completionRateEl.textContent = `${completionRate}%`;
            
            if (totalQuestions > 0) {
